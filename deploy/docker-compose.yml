# nanobot Docker Compose
#
# Runs both the gateway and WhatsApp bridge together.
# If you don't use WhatsApp, you can comment out or remove the bridge service.
#
# Usage:
#   1. Build:    docker compose build
#   2. Init:     docker compose run --rm gateway onboard
#   3. Config:   Edit ~/.nanobot/config.json (when using the named volume 'nanobot-data', the config lives inside the container/volume, not on the host). Use the following command to edit/view the config:
#               docker compose exec gateway vi /root/.nanobot/config.json
#               or
#               docker compose exec gateway cat /root/.nanobot/config.json
#               Alternatively, consider using a bind-mount for direct access to the config on the host (see comments at bottom).
#   4. Start:    docker compose up -d
#   5. Logs:     docker compose logs -f
#   6. Stop:     docker compose down

services:
  gateway:
    build:
      context: ../
      dockerfile: Dockerfile
    container_name: nanobot-gateway
    command: gateway
    restart: unless-stopped
    ports:
      - "18790:18790"
    volumes:
      - nanobot-data:/root/.nanobot
    depends_on:
      bridge:
        condition: service_started
        required: false  # gateway works fine without bridge (non-WhatsApp channels)
    environment:
      - TZ=${TZ:-UTC}

  bridge:
    build:
      context: ../
      dockerfile: Dockerfile
    container_name: nanobot-bridge
    command: channels login
    restart: unless-stopped
    expose:
      - "3001"
    volumes:
      - nanobot-data:/root/.nanobot
    environment:
      - TZ=${TZ:-UTC}
      - BRIDGE_HOST=0.0.0.0
    # Only needed if you use WhatsApp. Comment out this entire service if not.
    profiles:
      - whatsapp

volumes:
  nanobot-data:
    driver: local
    # To use your existing ~/.nanobot directory instead of a Docker volume,
    # replace this volume definition and the volume mounts above with:
    #   volumes:
    #     - ~/.nanobot:/root/.nanobot
